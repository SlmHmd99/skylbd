<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spot The Imposter — Mini Game (Code buttons)</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#f97316;
      --muted:#94a3b8;
      --glass:rgba(255,255,255,0.03);
      --btn-contrast: rgba(255,255,255,0.08);
      --btn-border: rgba(255,255,255,0.12);
      --btn-text: #e6eef8;
      --pool-bg: #f4f6fb;        /* new: pool button background */
      --pool-fore: #0b1628;      /* new: pool button text */
      --pool-border: rgba(11,22,40,0.08);
      --pool-hover: #e0e7ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#071127 0%, #0d1a2a 100%);
      color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:24px
    }
    .app{width:100%;max-width:920px}
    .card{background:var(--card);padding:20px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    header h1{font-size:18px;margin:0}
    .center{display:grid;place-items:center}

    .screen{display:none}
    .screen.active{display:block}

    .input-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=text]{flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}

    .letters{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    /* improved contrast for buttons */
    .btn{
      background:var(--btn-contrast);
      padding:10px 14px;border-radius:10px;border:1px solid var(--btn-border);
      cursor:pointer;transition:transform .12s ease,opacity .12s;user-select:none;
      color:var(--btn-text);font-weight:700;min-height:40px;display:inline-flex;align-items:center;justify-content:center;
      letter-spacing:0.6px
    }
    .btn:active{transform:translateY(2px)}
    .btn.primary{
      background:linear-gradient(180deg,#ff8a50,#f97316);color:#071127;font-weight:800;border:1px solid rgba(0,0,0,0.15)
    }

    .message{font-size:15px;color:var(--muted);margin-top:10px}

    /* Quiz layout */
    .quiz-hero{display:flex;gap:18px;align-items:center}
    .quiz-media{
      width:160px;height:120px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      display:grid;place-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      cursor:pointer;overflow:hidden;
    }
    .quiz-media img{width:100%;height:100%;object-fit:cover;display:block}
    .quiz-media .audio-thumb{font-size:12px;color:var(--muted);text-align:center;padding:8px}
    .choices{display:grid;gap:10px;margin-top:12px}
    .choice{
      padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      cursor:pointer;font-weight:700;color:var(--btn-text)
    }
    .choice.wrong{animation:shake .36s}
    .choice:focus{outline:2px solid rgba(249,115,22,0.2)}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(8px)}75%{transform:translateX(-6px)}100%{transform:translateX(0)}}

    /* final puzzle */
    .puzzle-area{display:grid;grid-template-columns:1fr 320px;gap:18px}
    .puzzle-left{display:flex;flex-direction:column;gap:12px}
    .slots{display:flex;gap:8px;flex-wrap:wrap}
    .slot{min-width:34px;height:46px;border-radius:8px;border:1px dashed rgba(255,255,255,0.06);display:grid;place-items:center;font-weight:700;background:transparent;cursor:pointer}
    .bank{display:flex;flex-wrap:wrap;gap:8px}
    .bank .btn{min-width:44px;text-align:center}

    footer{margin-top:18px;font-size:13px;color:var(--muted)}

    /* progress */
    .progress{height:12px;background: rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;margin-top:12px}
    .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#ffd166,#f97316);transition:width .28s ease}

    /* media modal */
    .media-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,0.75); z-index:50; padding:18px; overflow:auto }
    .media-box{ background:var(--card); padding:18px; border-radius:12px; max-width:920px; width:100%; box-shadow:0 20px 40px rgba(2,6,23,0.7); border:1px solid rgba(255,255,255,0.04) }
    .media-content{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap }
    .media-visual{ flex:0 0 360px; max-width:100%; border-radius:10px; overflow:hidden; background:#000; display:grid; place-items:center }
    .media-visual img{ width:100%; height:auto; display:block; }
    .media-info{ flex:1; min-width:200px; color:var(--muted) }
    .media-close{ margin-top:12px; text-align:right; }

    /* small helper for clickable area hint */
    .media-hint{ font-size:12px; color:var(--muted); margin-top:6px }

    /* responsive */
    @media (max-width:820px){
      .puzzle-area{grid-template-columns:1fr;}
      .quiz-hero{flex-direction:column}
      .quiz-media{width:100%;height:160px;border-radius:12px}
      .media-content{flex-direction:column}
      .media-visual{flex:1}
    }

    /* CODE SCREEN styling */
    .code-box{display:flex;flex-direction:column;gap:12px;align-items:center;padding:16px}
    .code-text{font-weight:900;color:#ffdca3;font-size:20px;letter-spacing:2px;background:rgba(255,255,255,0.02);padding:10px 14px;border-radius:8px}
    .code-slots{display:flex;gap:8px;margin-top:6px}
    .code-slot{min-width:44px;height:44px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);display:grid;place-items:center;font-weight:800;background:transparent;cursor:pointer}
    .code-slot.filled{background:rgba(255,255,255,0.02)}
    .code-pool{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px}
    /* pool button: brighter background and dark text for contrast */
    .pool-btn{
      min-width:44px;height:40px;border-radius:8px;border:1px solid var(--pool-border);display:inline-grid;place-items:center;padding:6px 10px;background:var(--pool-bg);color:var(--pool-fore);cursor:pointer;font-weight:800;
      box-shadow:0 2px 0 rgba(11,22,40,0.05);
    }
    .pool-btn:focus{outline:2px solid rgba(14,165,233,0.18)}
    .pool-btn:hover{background:var(--pool-hover)}
    .pool-btn.disabled{opacity:0.45;pointer-events:none}
    .controls{display:flex;gap:8px;margin-top:10px}
    .code-error{color:#ff6b6b;font-weight:700}
    .small-muted{font-size:12px;color:var(--muted)}
    /* shake for wrong code */
    .shake-err{animation:shake-err .36s}
    @keyframes shake-err{0%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(8px)}75%{transform:translateX(-6px)}100%{transform:translateX(0)}}
  </style>
</head>
<body>
  <div class="app card" role="application" aria-label="Spot the Imposter game">
    <header>
      <h1>SPOT THE IMPOSTER</h1>
      <div style="font-size:13px;color:var(--muted)"><span style="display:inline-block;margin-right:10px">Mobile friendly • No libs</span></div>
    </header>

    <!-- Screen 1: name input and letter buttons -->
    <section id="screen-name" class="screen active">
      <div class="center">
        <h2 style="margin:0 0 8px 0">Input your name</h2>
        <div class="card" style="width:100%;max-width:680px;padding:18px">
          <div class="input-row">
            <input id="nameInput" type="text" placeholder="Type your name (optional)" aria-label="Your name">
            <button id="startBtn" class="btn primary">Start</button>
          </div>

          <div class="message">Or choose one of these letters — tap any</div>
          <div class="letters" id="letterButtons" aria-hidden="false" style="margin-top:12px"></div>

          <div id="nameReveal" class="message" style="display:none;margin-top:12px;font-weight:700;color:#ffdca3"></div>
        </div>
      </div>
    </section>

    <!-- Screen 2: multiple-quest image/audio question (Q1 pool) -->
    <section id="screen-1" class="screen">
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <h2 style="margin:0">SPOT THE IMPOSTER — Challenge 1</h2>
          <!-- UI toggle for randomization -->
          <div class="switch" title="Toggle random order before starting">
            <label style="font-size:13px;color:var(--muted);">Randomize quests</label>
            <input id="randomizeToggle" type="checkbox" aria-label="Randomize quests">
          </div>
        </div>

        <div class="quiz-hero card" style="padding:14px">
          <div id="mediaArea" class="quiz-media" title="Tap to open media" role="button" tabindex="0" aria-label="Open media">
            <!-- dynamic content (image or audio hint) -->
          </div>

          <div style="flex:1">
            <p id="q1prompt" class="message">Pick the impostor from the options</p>

            <div class="progress" aria-hidden="false" title="Progress">
              <div id="q1Progress" class="progress-bar" style="width:0%"></div>
            </div>

            <div style="margin-top:8px;color:var(--muted);font-size:13px">
              <span id="q1Counter">Question 0 / 7</span>
              <span style="float:right;color:var(--muted)">Wrong: <strong id="wrongCounter">0</strong></span>
            </div>

            <div class="choices" id="choices1" style="margin-top:12px"></div>
          </div>
        </div>
        <div class="media-hint">Tap media (image/audio) to open and read/listen more details.</div>
      </div>
    </section>

    <!-- Screen 3: audio question -->
    <section id="screen-2" class="screen">
      <div>
        <h2>SPOT THE IMPOSTER</h2>
        <div class="card" style="padding:16px">
          <p class="message">Turn on your sound / raise volume to hear the clip</p>
          <audio id="audioClip" controls preload="none">
            <source src="audio/q2.mp3" type="audio/mpeg">
            Your browser does not support audio playback.
          </audio>

          <div class="choices" id="choices2" style="margin-top:14px"></div>
        </div>
      </div>
    </section>

    <!-- Screen 4: image question 2 -->
    <section id="screen-3" class="screen">
      <div>
        <h2>SPOT THE IMPOSTER</h2>
        <div class="quiz-hero card" style="padding:14px">
          <img id="q3img" src="images/q3.jpg" alt="Question image 3 - replace images/q3.jpg" style="width:160px;height:120px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
          <div style="flex:1">
            <p class="message">Choose the correct one</p>
            <div class="choices" id="choices3"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Screen 5: final puzzle -->
    <section id="screen-final" class="screen">
      <div>
        <h2 style="text-align:center">text text text...</h2>
        <div class="card" style="padding:16px;margin-top:12px">
          <div class="puzzle-area">
            <div class="puzzle-left">
              <div style="font-size:14px;color:var(--muted)">Assemble the correct word from the letters below</div>
              <div class="slots" id="slots"></div>
              <div style="margin-top:10px;color:var(--muted);font-size:13px">Tap letters to form the word. Press ⟲ to clear.</div>
            </div>
            <aside>
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <div style="flex:1"></div>
                <button id="clearBtn" class="btn">⟲ Clear</button>
              </div>

              <div class="bank" id="bank"></div>
            </aside>
          </div>
        </div>
      </div>
    </section>

    <!-- NEW: Code entry screen with clickable buttons (masked code) -->
    <section id="screen-code" class="screen">
      <div>
        <h2 style="text-align:center">Enter the access code</h2>
        <div class="card" style="padding:16px;margin-top:12px">
          <div class="code-box">
            <div class="message">You've finished the first challenge. Assemble the hidden code from the characters below.</div>
            <!-- masked display: don't reveal the code -->
            <div id="displayCode" class="code-text" aria-live="polite">•••-•••</div>

            <div class="code-slots" id="codeSlots" aria-hidden="false" style="margin-top:10px"></div>

            <div class="code-pool" id="codePool" style="margin-top:12px"></div>

            <div class="controls">
              <button id="backspaceBtn" class="btn">⌫ Back</button>
              <button id="clearPoolBtn" class="btn">Clear</button>
              <button id="submitCodeBtn" class="btn primary">Submit</button>
            </div>

            <div id="codeError" class="code-error" style="display:none"></div>
            <div class="small-muted">Tip: click characters to fill slots. Click filled slot to return it.</div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- Media modal -->
  <div id="mediaOverlay" class="media-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="media-box" role="document">
      <div class="media-content">
        <div class="media-visual" id="mediaVisual"></div>
        <div class="media-info">
          <h4 id="mediaTitle" style="margin:0;color:#ffdca3">Media</h4>
          <p id="mediaDesc" style="margin-top:8px;color:var(--muted)"></p>
          <div class="media-close">
            <button id="mediaCloseBtn" class="btn">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /*****************************************************************************
     * CONFIG
     *****************************************************************************/
    const ASSET_PATH = '';
    const Q1_TOTAL = 7;
    let MAX_WRONG = 3;
    const REVEAL_DURATION = 2200;
    let RANDOMIZE_QUESTS = false;

    const Q1_POOL = [
      { type: 'image', src: './images/q1.jpg', prompt: 'Which one is the impostor (tap on the image to zoom)', choices: ['Chimpanzini bananini','tung tung tung sahur','lirili larila','bombreto bondito'], correctIndex: 0, info: 'Hint: the imposter is in a weird costume' },
      { type: 'audio', src: './audio/q2.mp3', prompt: 'Listen and pick the odd sound (tap on the audio file to listen)', choices: ['Trippi Troppi Troppa Trippa tuk','Bombombini Gusini','Bobrito Bandito','tung tung tung sahur'], correctIndex: 3, info: '' },
      { type: 'image', src: './images/q3.jpg', prompt: 'Pick the odd one out (silly)', choices: ['Tung Tung Tung Sahur','Capuccino Assassino','Bombombini Gusini','La Vaca Saturno Saturnita:'], correctIndex: 2, info: '' },
      { type: 'image', src: './images/q4.jpg', prompt: '', choices: ['Trippi Troppi','Capuccino Assassino','Frigo Camello','ballerina cappuccina'], correctIndex: 1, info: 'its always a cup' },
      { type: 'image', src: './images/q5.jpg', prompt: '', choices: ['Tung Tung Tung Sahur','Capuccino Assassino','Bombombini Gusini','ballerina cappuccina'], correctIndex: 3, info: 'she is dancing' },
      { type: 'image', src: './images/q6.jpg', prompt: '', choices: ['Trippi Troppi','Capuccino Assassino','lirili larila','ballerina cappuccina'], correctIndex: 2, info: 'LRLLRL' },
      { type: 'image', src: './images/q7.jpg', prompt: '', choices: ['Trippi Troppi','la vaca saturno saturnita','Frigo Camello','ballerina cappuccina'], correctIndex: 1, info: 'la vaca in portugais is a cow' },
    ];

    /*****************************************************************************
     * helpers & UI wiring
     *****************************************************************************/
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr }
    function escapeHtml(t){ return String(t).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]) }
    function normalize(s){ return String(s||'').toUpperCase().replace(/[^A-Z0-9]/g,''); }

    const mediaOverlay = document.getElementById('mediaOverlay');
    const mediaVisual = document.getElementById('mediaVisual');
    const mediaTitle = document.getElementById('mediaTitle');
    const mediaDesc = document.getElementById('mediaDesc');
    const mediaCloseBtn = document.getElementById('mediaCloseBtn');
    mediaCloseBtn.addEventListener('click', () => { closeMediaModal(); });
    mediaOverlay.addEventListener('click', e => { if(e.target === mediaOverlay) closeMediaModal(); });
    document.addEventListener('keydown', (e) => { if(e.key === 'Escape' && mediaOverlay.style.display === 'flex') closeMediaModal(); });

    function openMediaModal(item){
      mediaVisual.innerHTML = '';
      mediaTitle.textContent = item.prompt || 'Media';
      mediaDesc.textContent = item.info || '';
      if((item.type || 'image') === 'audio'){
        const audio = document.createElement('audio'); audio.controls=true; audio.preload='none';
        const s=document.createElement('source'); s.src=(ASSET_PATH||'')+(item.src||''); s.type='audio/mpeg'; audio.appendChild(s);
        mediaVisual.appendChild(audio);
      } else {
        const img=document.createElement('img'); img.alt=item.prompt||'Question image'; img.src=(ASSET_PATH||'')+(item.src||''); img.style.maxWidth='100%'; mediaVisual.appendChild(img);
      }
      mediaOverlay.style.display='flex';
      mediaOverlay.setAttribute('aria-hidden','false');
    }
    function closeMediaModal(){ const aud=mediaVisual.querySelector('audio'); if(aud && !aud.paused) try{aud.pause()}catch(e){} mediaOverlay.style.display='none'; mediaOverlay.setAttribute('aria-hidden','true'); }

    // populate name-screen letters
    const lettersContainer = document.getElementById('letterButtons');
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const letterSet = shuffle(Array.from(alphabet)).slice(0,14);
    letterSet.forEach(l=>{
      const b=document.createElement('button'); b.className='btn'; b.textContent=l; b.setAttribute('aria-label','Pick letter '+l);
      b.addEventListener('click', ()=> revealName(l));
      lettersContainer.appendChild(b);
    });
    function revealName(letter){ showBigReveal("No need pfft, I ALREADY KNOW YOU LANA !!!", "Let's start the challenge...", REVEAL_DURATION+800); }
    document.getElementById('startBtn').addEventListener('click', ()=> { showBigReveal("No need pfft, I ALREADY KNOW YOU LANA!!!!","Get ready for the quests...",REVEAL_DURATION+800); });

    // Q1 logic (same as before, but when done -> show code screen)
    const mediaArea = document.getElementById('mediaArea');
    const choices1El = document.getElementById('choices1');
    const q1Prompt = document.getElementById('q1prompt');
    const q1ProgressBar = document.getElementById('q1Progress');
    const q1Counter = document.getElementById('q1Counter');
    const wrongCounterEl = document.getElementById('wrongCounter');

    let q1Sequence = [];
    let q1Index = 0;
    let wrongCount = 0;

    function prepareSequence(){
      let pool = Q1_POOL.slice();
      if(RANDOMIZE_QUESTS) pool = shuffle(pool);
      const seq = pool.slice(0, Math.min(Q1_TOTAL, pool.length));
      while(seq.length < Q1_TOTAL) seq.push(pool[Math.floor(Math.random()*pool.length)]);
      return seq;
    }
    function startQuiz1(){
      q1Sequence = prepareSequence(); q1Index = 0; wrongCount = 0; updateWrongDisplay(); updateProgress(); renderQ1Current(); showScreen('screen-1');
    }
    function renderQ1Current(){
      const q = q1Sequence[q1Index];
      q1Prompt.textContent = q.prompt || 'Pick the impostor from the options';
      mediaArea.innerHTML = '';
      const type = (q.type || 'image');
      if(type === 'audio'){
        const div = document.createElement('div'); div.className='audio-thumb';
        div.innerHTML = `<div style="font-weight:800;color:#ffdca3;margin-bottom:6px">Audio</div><div style="font-size:12px;color:var(--muted)">${q.info||'Tap to open audio player'}</div>`;
        mediaArea.appendChild(div);
      } else {
        const img=document.createElement('img'); img.alt=q.prompt||'Question image'; img.src=(ASSET_PATH||'')+(q.src||''); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
        mediaArea.appendChild(img);
      }
      mediaArea.onclick = ()=> openMediaModal({...q, src: (ASSET_PATH||'')+(q.src||'')});
      mediaArea.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' ') openMediaModal({...q, src: (ASSET_PATH||'')+(q.src||'')}); };

      choices1El.innerHTML='';
      q.choices.forEach((choice,i)=>{
        const el=document.createElement('div'); el.className='choice'; el.textContent=choice; el.tabIndex=0;
        el.addEventListener('click', ()=> handleQ1Answer(i));
        choices1El.appendChild(el);
      });
      q1Counter.textContent = `Question ${q1Index+1} / ${Q1_TOTAL}`;
    }

    function handleQ1Answer(selectedIndex){
      const q = q1Sequence[q1Index];
      const correct = (q.correctIndex === selectedIndex);
      const choiceNodes = Array.from(choices1El.children);
      if(correct){
        choiceNodes[selectedIndex].style.opacity = 0.9;
        q1Index++;
        updateProgress();
        if(q1Index >= Q1_TOTAL){
          setTimeout(()=>{ showCodeScreen(); }, 300);
        } else {
          setTimeout(()=>{ renderQ1Current(); }, 360);
        }
      } else {
        choiceNodes[selectedIndex].classList.add('wrong');
        setTimeout(()=>choiceNodes[selectedIndex].classList.remove('wrong'),360);
        wrongCount++; updateWrongDisplay();
        if(wrongCount >= MAX_WRONG){ setTimeout(()=>{ triggerTooManyWrongs() }, 420); }
      }
    }
    function updateProgress(){ const percent=Math.round((q1Index/Q1_TOTAL)*100); q1ProgressBar.style.width=percent+'%'; q1Counter.textContent = `Question ${Math.min(q1Index+1,Q1_TOTAL)} / ${Q1_TOTAL}`; }
    function updateWrongDisplay(){ wrongCounterEl.textContent = wrongCount; }
    function triggerTooManyWrongs(){ showBigReveal('Too many wrong answers — you must start over!', 'Try again, and good luck!', 2600); q1Sequence=[]; q1Index=0; wrongCount=0; updateProgress(); updateWrongDisplay(); showScreen('screen-name'); }

    // placeholders
    const Q2_CHOICES = ['choice 1','choice 2','choice 3','choice 4'];
    const Q2_CORRECT_INDEX = 3;
    const Q3_CHOICES = ['Alpha','Bravo','Charlie','Delta'];
    const Q3_CORRECT_INDEX = 2;
    const FINAL_WORD = 'BOMBINI';
    function startQuiz2(){ const c2=document.getElementById('choices2'); c2.innerHTML=''; Q2_CHOICES.forEach((choice,i)=>{ const el=document.createElement('div'); el.className='choice'; el.textContent=choice; el.tabIndex=0; el.addEventListener('click', ()=>{ if(i===Q2_CORRECT_INDEX){ showScreen('screen-3'); } else { el.classList.add('wrong'); setTimeout(()=>el.classList.remove('wrong'),360); } }); c2.appendChild(el); }); }
    function startQuiz3(){ const c3=document.getElementById('choices3'); c3.innerHTML=''; Q3_CHOICES.forEach((choice,i)=>{ const el=document.createElement('div'); el.className='choice'; el.textContent=choice; el.tabIndex=0; el.addEventListener('click', ()=>{ if(i===Q3_CORRECT_INDEX){ startFinalPuzzle(); } else { el.classList.add('wrong'); setTimeout(()=>el.classList.remove('wrong'),360); } }); c3.appendChild(el); }); }

    // final puzzle (unchanged)
    function startFinalPuzzle(){
      const target = FINAL_WORD.toUpperCase();
      const slotsEl = document.getElementById('slots'); slotsEl.innerHTML='';
      const bankEl = document.getElementById('bank'); bankEl.innerHTML='';
      const len = Math.max(7, target.length);
      for(let i=0;i<target.length;i++){const s=document.createElement('div'); s.className='slot'; s.dataset.index=i; s.textContent=''; slotsEl.appendChild(s)}
      const bankLetters = target.split("");
      while(bankLetters.length < len) bankLetters.push(randomLetter());
      shuffle(bankLetters);
      bankLetters.forEach((L, idx)=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=L; b.dataset.index=idx; b.addEventListener('click', ()=>{ pickBankLetter(b); }); bankEl.appendChild(b); });
      document.getElementById('clearBtn').addEventListener('click', clearSlots);
      showScreen('screen-final');
    }
    function pickBankLetter(btn){ const slots = Array.from(document.querySelectorAll('#slots .slot')); const empty = slots.find(s=>!s.textContent); if(!empty) return; empty.textContent = btn.textContent; empty.dataset.from = btn.dataset.index; btn.disabled=true; btn.style.opacity=0.5; checkFinalAnswer(); }
    function clearSlots(){ document.querySelectorAll('#slots .slot').forEach(s=>{s.textContent='';delete s.dataset.from}); document.querySelectorAll('#bank button').forEach(b=>{b.disabled=false;b.style.opacity=1}); }
    function checkFinalAnswer(){ const formed = Array.from(document.querySelectorAll('#slots .slot')).map(s=>s.textContent||'').join(''); if(formed.length === FINAL_WORD.length && formed.toUpperCase() === FINAL_WORD.toUpperCase()){ setTimeout(()=>{ document.querySelector('#screen-final h2').textContent = 'YOU FOUND THE WORD!'; const card = document.querySelector('#screen-final .card'); const extra = document.createElement('div'); extra.style.marginTop='12px'; extra.style.fontSize='15px'; extra.style.color='#fdf6e3'; extra.innerHTML = '<strong>Congratulations!</strong> Here is the next text...'; card.appendChild(extra); },220); } }
    function randomLetter(){ const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ'; return letters[Math.floor(Math.random()*letters.length)] }

    // click on slot to return letter to bank (final puzzle)
    document.addEventListener('click', e=>{
      if(e.target && e.target.classList.contains('slot')){
        const slot = e.target; if(!slot.textContent) return;
        const fromIndex = slot.dataset.from; slot.textContent=''; delete slot.dataset.from;
        const bankBtn = document.querySelector(`#bank button[data-index='${fromIndex}']`);
        if(bankBtn){ bankBtn.disabled=false; bankBtn.style.opacity=1 }
        checkFinalAnswer();
      }
    });

    // screen helper
    function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }

    // boot placeholders
    startQuiz2();
    startQuiz3();

    // Utilities
    window.setMaxWrong = function(n){ MAX_WRONG = parseInt(n) || 3; console.info('MAX_WRONG set to', MAX_WRONG) };
    window.setRandomizeDefault = function(b){ RANDOMIZE_QUESTS = !!b; document.getElementById('randomizeToggle').checked = RANDOMIZE_QUESTS; console.info('RANDOMIZE_QUESTS set to', RANDOMIZE_QUESTS) };

    /*******************************
     * CODE-SCREEN logic (buttons input)
     *******************************/
    let ONE_TIME_CODE = null;
    const POOL_CHARS = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';

    function generateCode(len = 6){
      let s = '';
      for(let i=0;i<len;i++) s += POOL_CHARS[Math.floor(Math.random()*POOL_CHARS.length)];
      return s.slice(0,3) + '-' + s.slice(3);
    }

    function showCodeScreen(){
      ONE_TIME_CODE = "SKY";
      // display masked string instead of revealing the code
      const masked = '•'.repeat(3) + '-' + '•'.repeat(3);
      document.getElementById('displayCode').textContent = masked;
      document.getElementById('codeError').style.display = 'none';
      buildCodeEntryUI();
      showScreen('screen-code');
    }

    function buildCodeEntryUI(){
      const normalized = normalize(ONE_TIME_CODE); // e.g. "ABC123"
      const slotsContainer = document.getElementById('codeSlots');
      const poolContainer = document.getElementById('codePool');
      slotsContainer.innerHTML = '';
      poolContainer.innerHTML = '';

      // create slots
      for(let i=0;i<normalized.length;i++){
        const s = document.createElement('div');
        s.className = 'code-slot';
        s.dataset.pos = i;
        s.textContent = '';
        s.addEventListener('click', ()=> {
          if(!s.textContent) return;
          const poolIndex = s.dataset.from;
          s.textContent = '';
          s.classList.remove('filled');
          delete s.dataset.from;
          const btn = document.querySelector(`.pool-btn[data-pool-index="${poolIndex}"]`);
          if(btn){ btn.classList.remove('disabled'); btn.dataset.disabled = '0'; }
          hideCodeError();
        });
        slotsContainer.appendChild(s);
      }

      // pool = code chars (with duplicates) + extras
      const pool = normalized.split('');
      while(pool.length < Math.max(12, normalized.length + 8)){
        pool.push(POOL_CHARS[Math.floor(Math.random()*POOL_CHARS.length)]);
      }
      shuffle(pool);

      pool.forEach((ch, idx)=>{
        const b = document.createElement('button');
        b.className = 'pool-btn';
        b.textContent = ch;
        b.dataset.letter = ch;
        b.dataset.poolIndex = idx;
        b.addEventListener('click', ()=> { placePoolLetter(b); });
        poolContainer.appendChild(b);
      });

      document.getElementById('backspaceBtn').onclick = backspaceSlot;
      document.getElementById('clearPoolBtn').onclick = clearAllSlots;
      document.getElementById('submitCodeBtn').onclick = manualSubmitCode;
    }

    function placePoolLetter(btn){
      if(btn.classList.contains('disabled')) return;
      const slots = Array.from(document.querySelectorAll('#codeSlots .code-slot'));
      const empty = slots.find(s => !s.textContent);
      if(!empty) return;
      empty.textContent = btn.dataset.letter;
      empty.classList.add('filled');
      empty.dataset.from = btn.dataset.poolIndex;
      btn.classList.add('disabled');
      btn.dataset.disabled = '1';
      hideCodeError();
      const formed = slots.map(s=>s.textContent||'').join('');
      if(formed.length === slots.length){
        setTimeout(()=> verifyCodeFromSlots(), 220);
      }
    }

    function backspaceSlot(){
      const slots = Array.from(document.querySelectorAll('#codeSlots .code-slot'));
      for(let i=slots.length-1;i>=0;i--){
        const s = slots[i];
        if(s.textContent){
          const poolIndex = s.dataset.from;
          s.textContent = ''; s.classList.remove('filled'); delete s.dataset.from;
          const btn = document.querySelector(`.pool-btn[data-pool-index="${poolIndex}"]`);
          if(btn){ btn.classList.remove('disabled'); btn.dataset.disabled='0'; }
          hideCodeError();
          return;
        }
      }
    }

    function clearAllSlots(){
      const slots = Array.from(document.querySelectorAll('#codeSlots .code-slot'));
      slots.forEach(s=>{ if(s.textContent){ const poolIndex = s.dataset.from; s.textContent=''; s.classList.remove('filled'); delete s.dataset.from; const btn = document.querySelector(`.pool-btn[data-pool-index='${poolIndex}']`); if(btn){ btn.classList.remove('disabled'); btn.dataset.disabled='0'; } }});
      hideCodeError();
    }

    function verifyCodeFromSlots(){
      const slots = Array.from(document.querySelectorAll('#codeSlots .code-slot'));
      const formed = slots.map(s=>s.textContent||'').join('');
      const normalizeFormed = normalize(formed);
      const normalizeCode = normalize(ONE_TIME_CODE);
      if(normalizeFormed === normalizeCode){
        goToSecretPage();
      } else {
        showCodeError('Incorrect code — try again.');
        const cont = document.getElementById('codeSlots');
        cont.classList.remove('shake-err'); void cont.offsetWidth; cont.classList.add('shake-err');
      }
    }

    function manualSubmitCode(){ verifyCodeFromSlots(); }

    function showCodeError(msg){
      const el = document.getElementById('codeError'); el.textContent = msg; el.style.display='block';
    }
    function hideCodeError(){ const el = document.getElementById('codeError'); el.style.display='none'; el.textContent=''; }

    function goToSecretPage(){
       window.location.href = "./index_2f.html";
    }

    // simple reveal used earlier
    function showBigReveal(text, subtext='', duration=REVEAL_DURATION){
      const box = document.createElement('div');
      box.style.position='fixed'; box.style.left=0; box.style.top=0; box.style.right=0; box.style.bottom=0; box.style.display='grid'; box.style.placeItems='center'; box.style.background='rgba(2,6,23,0.6)'; box.style.zIndex=9999;
      const card = document.createElement('div'); card.style.padding='20px'; card.style.borderRadius='12px'; card.style.background='linear-gradient(180deg,#0b1220,#0f1622)'; card.style.border='1px solid rgba(255,255,255,0.06)'; card.style.color='#fff'; card.innerHTML = `<h3 style="margin:0 0 8px 0;color:#ffdca3">${escapeHtml(text)}</h3><div style="color:var(--muted)">${escapeHtml(subtext)}</div>`;
      box.appendChild(card);
      document.body.appendChild(box);
      setTimeout(()=>{ document.body.removeChild(box); startQuiz1(); }, duration);
    }

    // Start protections: allow Enter to start
    document.getElementById('nameInput').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('startBtn').click(); });

    // Start boot
    startQuiz2();
    startQuiz3();

    // debug helpers
    window._debug = { showCodeScreen, generateCode, ONE_TIME_CODE };
  </script>
</body>
</html>
